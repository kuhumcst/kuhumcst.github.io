{"version":3,"sources":["kuhumcst/rescope/interop.cljs"],"mappings":"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","names":["kuhumcst.rescope.interop/extend-class*","parent","props-obj","construct","child","obj","js/Reflect.construct","child*","prototype","js/Object.create","or__4126__auto__","js/undefined","kuhumcst.rescope.interop/js-props","props","wrap-method","f","args","this","G__56343","iter__4529__auto__","s__56345","cljs.core/LazySeq","temp__5735__auto__","cljs.core/seq","cljs.core/chunked-seq?","c__4527__auto__","size__4528__auto__","cljs.core/count","b__56347","cljs.core/chunk-buffer","i__56346","vec__56350","cljs.core/-nth","cljs.core.nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__56344","cljs.core/chunk-rest","vec__56357","cljs.core/first","cljs.core/cons","cljs.core/rest","k","v","cljs.core/fn?","cljs.core.into","cljs.core/clj->js","var_args","args__4742__auto__","len__4736__auto__","i__4737__auto__","argseq__4743__auto__","cljs.core/IndexedSeq","kuhumcst.rescope.interop/extend-class","p__56375","vec__56386","map__56389","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","cljs.core.get","seq56367","G__56368","cljs.core/next","self__4723__auto__","cljs.core.dissoc","kuhumcst.rescope.interop/define-element!","p__56412","vec__56414","seq56402","G__56403","tag","js/window.customElements.get","element","kuhumcst.rescope.interop.extend_class","js/HTMLElement","js/window.customElements.define","p__56430","map__56431","kuhumcst.rescope.interop/blob","coll","type","opts","js/Blob","cljs.core/array","kuhumcst.rescope.interop/auto-revoked","a","cljs.core/add-watch","r","o","n","and__4115__auto__","cljs.core.not_EQ_","js/URL.revokeObjectURL","kuhumcst.rescope.interop/blob-url","cljs.core/memoize","js/URL.createObjectURL","p__56452","map__56453","kuhumcst.rescope.interop/request","url","method","headers","on-progress","xhr","js/XMLHttpRequest","s__56459","b__56461","i__56460","vec__56472","iter__56458","vec__56475","js/kuhumcst","js/kuhumcst.rescope","js/kuhumcst.rescope.interop","js/kuhumcst.rescope.interop.event-data","method-table__4619__auto__","cljs.core.atom","prefer-table__4620__auto__","method-cache__4621__auto__","cached-hierarchy__4622__auto__","hierarchy__4623__auto__","fexpr__56484","cljs.core/MultiFn","cljs.core.symbol","p1__56478#","kuhumcst.rescope.interop/event-data","event","cljs.core/chunk-first"],"sourcesContent":["(ns kuhumcst.rescope.interop\n  \"Wrapping gnarly JS interop with the browser API in a smart way.\n\n  NOTE: fns marked with ^:experimental rely on experimental browser APIs.\")\n\n;; Useful documentation of the JS interop used in this code:\n;; * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Details_of_the_Object_Model\n;; * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/create\n;; * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty\n;;\n;; Explaining why super() can't be extended:\n;; * https://stackoverflow.com/questions/43836886/failed-to-construct-customelement-error-when-javascript-file-is-placed-in-head\n\n;; Note: js/Reflect.construct simply replicates a call to super() and in the\n;; case of custom HTML elements, the constructor must otherwise be empty!\n(defn- extend-class*\n  \"Private implementation of extend-class, expecting only JavaScript types. This\n  is simply a way to emulate the more modern class-based JS while still using\n  its prototype-based subclassing.\n\n  The primary goal was to emulate a call to super() in the constructor. This is\n  a requirement when creating custom HTML components.\"\n  [parent props-obj construct]\n  (let [child     (fn child* []\n                    (let [obj (js/Reflect.construct parent #js[] child*)]\n                      (when construct\n                        (construct obj))\n                      obj))\n        prototype (js/Object.create (.-prototype parent) (or props-obj\n                                                             js/undefined))]\n    (set! (.-prototype child) prototype)\n    child))\n\n(defn- js-props\n  \"Convert a map of properties into a properties object that can be consumed by\n  extend-class*.\"\n  [props]\n  (let [wrap-method (fn [f]\n                      (fn [& args]\n                        (this-as this (f this args))))]\n    (some->> (for [[k v] props]\n               [k {:value (if (fn? v)\n                            (wrap-method v)\n                            v)}])\n             (into {})\n             (clj->js))))\n\n(defn extend-class\n  \"Extend the prototype of a `parent` class with a map of object `props`.\"\n  [parent & [{:keys [construct] :as props}]]\n  (extend-class* parent (js-props (dissoc props :construct)) construct))\n\n(defn define-element!\n  \"Define a custom element based on a `tag` name. Can optionally take a map of\n  `props` to refine the prototype of the new HTMLElement subclass.\"\n  [tag & [props]]\n  (when (undefined? (js/window.customElements.get tag))\n    (let [element (extend-class js/HTMLElement props)]\n      (js/window.customElements.define tag element))))\n\n(defn blob\n  \"Create a Blob object from a `coll` of content and a `type` (from `opts`).\"\n  [coll {:keys [type] :as opts}]\n  (js/Blob. (apply array coll) (clj->js opts)))\n\n(defn ^:experimental auto-revoked\n  \"Wrap an atom `a` holding an object URL to auto-revoke the older objects.\"\n  [a]\n  (add-watch a :change (fn [k r o n] (when (and o (not= o n))\n                                       (js/URL.revokeObjectURL o)))))\n\n(def ^:experimental blob-url\n  \"Create (or reuse) an object URL for a custom Blob based on `coll` and `opts`.\n  Use together with auto-revoked to properly garbage-collect dangling objects.\"\n  (memoize (fn [coll opts] (js/URL.createObjectURL (blob coll opts)))))\n\n;; TODO: finish, still very WIP\n;; See: https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest\n;; https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch\n(defn request\n  \"Wrapping XMLHttpRequest as a function to make it more accessible.\"\n  [{:keys [url\n           method\n           headers\n           on-progress]\n    :or   {method \"GET\"}\n    :as   opts}]\n  (let [xhr (js/XMLHttpRequest.)]\n    (.open xhr method url)\n    (for [[k v] headers]\n      (.setRequestHeader xhr k v))\n    (when on-progress\n      (set! (.-onprogress xhr) on-progress))\n    (.send xhr)))\n\n(defmulti event-data #(.-type %))\n\n(defmethod event-data \"progress\"\n  [event]\n  {:loaded (.-loaded event)\n   :total  (when (.-lengthComputable event)\n             (.-total event))})\n"]}