{"version":3,"sources":["clj_diff/miller.cljc"],"mappings":";AAOA;;;;;;AAAA,AAAOA,AAKJC,AAAEC;AALL,AAME,AAAAC,AAAK,AAAA,AAAK,AAAA,AAACE,AAAIH,AAAG,AAAA,AAAKD;AAAvBG,AACK,AAAA,AAACC,AAAIH,AAAG,AAAA,AAAKD;AADlB,AAAA,AAAAE,AAAAC,AAAAD,AAAAC;;AAGF;;;;;AAAA,AAAOG,AAIJC,AAAEC,AAAEC,AAAEC,AAAEV,AAAEC;AAJb,AAAA,AAKS,AAAK,AAACU,AAAQJ,AAAG,AAACI,AAAQH;AALnC;AAAA,AAAA,AAAA,AAAAH,AAAA;;;AAME,AAAMO,AAAE,AAACb,AAAOC,AAAEC;AACZY,AAAE,AAAGD,AAAEZ;AADb,AAEE,AAAOY,AAAEA;AACFC,AAAEA;;AADT,AAEE,AAAI,AAAK,AAAGD,AAAEH,AAAG,AAAGI,AAAEH,AAAG,AAACI,AAAE,AAACV,AAAIG,AAAE,AAAA,AAAKK,AAAI,AAACR,AAAII,AAAE,AAAA,AAAKK;AACtD,AAAO,AAAA,AAAKD;AAAG,AAAA,AAAKC;;;;;AACpBD;;;;;AAER;;;AAAA,AAAOG,AAEJC,AAAEC;AAFL,AAGE,AAAA,AAACC,AAAO,AAACC,AAAM,AAAA,AAAMH,AAAGC,AAChB,AAACG,AAAQ,AAACD,AAAM,AAAA,AAAKF,AAAO,AAAGA,AAAM,AAAA,AAAKD,AACzCC;;AAEX;;;;;;;AAAA,AAAOI,AAMJd,AAAEC,AAAEC,AAAEC,AAAEO,AAAMD,AAAEf;AANnB,AAOE,AAACqB,AAAO,AAAKrB,AAAGsB;AAAR,AACE,AAACC,AAAMvB,AAAGsB,AAAO,AAACjB,AAAMC,AAAEC,AAAEC,AAAEC,AAAEa,AAAOtB;AACzCA,AACA,AAACc,AAAiBC,AAAEC;;AAE9B;;;;;;AAAA,AAAMQ,AAKHlB,AAAEC;AALL,AAAA,AAMS,AAAI,AAACkB,AAAMnB,AAAG,AAACmB,AAAMlB;AAN9B;AAAA,AAAA,AAAA,AAAAH,AAAA;;;AAOE,AAAMI,AAAE,AAAA,AAAK,AAACiB,AAAMnB;AACdG,AAAE,AAAA,AAAK,AAACgB,AAAMlB;AACdS,AAAM,AAAGR,AAAEC;AAFjB,AAGE,AAAA,AAAOM;AAAP,AACOf;;AADP,AAEE,AAAI,AAACa,AAAM,AAAA,AAACV,AAAIH,AAAG,AAAA,AAAKe,AACb,AAACZ,AAAIa,AACTR;AAFP,AAGG,AAAA,AAAKO,AAAGC,AAAMhB;;AACf,AAAO,AAAA,AAAKe;AACL,AAACQ,AAAMvB,AAAGe,AACH,AAACK,AAAcd,AAAEC,AAAEC,AAAEC,AAAEO,AAAMD,AAAE,AAAA,AAACZ,AAAIH,AAAG,AAAA,AAAKe;;;;;;;;AAMlE;;;AAAA,AAAMW,AAEHV,AAAMD,AAAEhB;AAFX,AAGE,AAAI,AAAGA,AAAEiB;AACP,AAAG,AAAA,AAAK,AAAGD,AAAE,AAAGhB,AAAEiB,AAASjB;;AAC3B,AAAG,AAAA,AAAKgB,AAAGhB;;;AAEf;;;;AAAA,AAAO4B,AAGJX,AAAMD,AAAEhB;AAHX,AAIE,AAAI,AAAG,AAAA,AAAKA,AAAGiB;AAAOD;;AAAE,AAAA,AAAKA;;;AAE/B;;;;AAAA,AAAOa,AAGJZ,AAAMD,AAAEhB;AAHX,AAIE,AAAI,AAAG,AAAA,AAAKA,AAAGiB;AAAOD;;AAAE,AAAA,AAAKA;;;AAE/B;;;;AAAA,AAAOc,AAGJC,AAAMd,AAAMD,AAAEJ,AAAEZ;AAHnB,AAIE,AAAM,AAAA,AAAG,AAAGY,AAAEZ;AAAd,AACE,AAAMgC,AAAK,AAAA,AAAKhC;AACViC,AAAK,AAACL,AAAWX,AAAMD,AAAEhB;AACzBkC,AAAOH,AACA,AAAA,AAAC3B,AAAI6B,AACL,AAAA,AAAC7B,AAAI4B;AAJlB,AAKE,AAAM,AAAK,AAAA,AAAIE,AAAM,AAACpB,AAAEF,AAAEsB;AAA1B,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAEMA,AACAD,AACAD,AACA,AAACL,AAAUV,AAAMgB,AAAKD;;AAL5B;;;AANJ;;;AAaF;;;;AAAA,AAAOG,AAGJJ,AAAMd,AAAMD,AAAEJ,AAAEZ;AAHnB,AAIE,AAAM,AAAA,AAAGY;AAAT,AACE,AAAMwB,AAAO,AAAA,AAAKpC;AACZqC,AAAO,AAACR,AAAaZ,AAAMD,AAAEhB;AAC7BkC,AAAOH,AACA,AAAA,AAAC3B,AAAIiC,AACL,AAAA,AAACjC,AAAIgC;AAJlB,AAKE,AAAM,AAAK,AAAA,AAAIF,AAAM,AAACpB,AAAE,AAAA,AAAKF,AAAGsB;AAAhC,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAEMA,AACAG,AACAD,AACA,AAACT,AAAUV,AAAMoB,AAAOD;;AAL9B;;;AANJ;;;AAaF;;;AAAA,AAAOE,AAEJ/B,AAAEC,AAAEI,AAAEC;AAFT,AAAA,AAGS,AAAK,AAAA,AAAID,AAAK,AAAA,AAAIC;AAH3B;AAAA,AAAA,AAAA,AAAAR,AAAA;;;AAIE,AAAOO,AAAEA;AACFC,AAAEA;;AADT,AAEE,AAAI,AAAI,AAAA,AAACC,AAAEF,AAAEC,AAAK,AAAK,AAACC,AAAE,AAACV,AAAIG,AAAEK,AAAG,AAACR,AAAII,AAAEK;AACzCD;;AACA,AAAO,AAAA,AAAKA;AAAG,AAAA,AAAKC;;;;;;;;AAK1B;;;;AAAA,AAAO2B,AAGJjC,AAAEC,AAAEuB,AAAMd,AAAMD,AAAEJ,AAAEZ;AAHvB,AAAA,AAAAuC,AAKE,AAAME,AAAE,AAACd,AAAUV,AAAMD,AAAEhB;AACrB0C,AAAO,AAACJ,AAAgB/B,AAAEC,AAAEI,AAAE,AAAGA,AAAEZ;AADzC,AAEE,AAAO0C,AAAOA;;AAAd,AACE,AAAMC,AAAK,AAACC,AAAM,AAAA,AAACE;AAADD;AAAA,AAAS,AAAK,AAAK,AAAAA,AAAA,AACL,AAAC/B,AAAE,AAAA,AAAA+B,AAAO,AAAA,AAAKJ;;AACrB,AAAA,AAACO;AAADD;AAAA,AAAM,AAAAA,AAAAA,AAAAA,AAAGhB,AAAAA,AAAMd,AAAAA,AAAMD,AAAAA,AAAE0B,AAAAA,AAAO1C,AAAAA;;AAA9B,AACMmC,AAAUL;AAH1C,AAIE,AAAI,AAAK,AAAGY,AAAO9B,AAAG,AAAA,AAAM+B;AAC1B,AAAO,AAAA,AAAKD;;;;AACZC;;;;;AAdV,AAAA,AAIU,AAAC7B,AAAE,AAAA,AAAK,AAACa,AAAUV,AAAMD,AAAEhB,AAAI,AAAA,AAAIuC;AAJ7C;AAAA,AAAA,AAAA,AAAAlC,AAAA;;;AAAAkC;;AAgBA;;;;AAAA,AAAOU,AAGJ1C,AAAEC,AAAEQ,AAAEC,AAAMc;AAHf,AAIE,AAAMmB,AAAQ,AAACC,AAAQX,AAAUjC,AAAEC,AAAEuB,AAAMd;AAA3C,AACE,AAAA,AAAA,AAAOmC;AAAP,AAAA,AAAA,AAAA,AAAA,AACOC,AAAS,AAAC3B,AAAMnB,AAAMS,AAAKC,AAClB,AAACU,AAAUV,AAAMD,AAAEC;;AAFnC,AAGE,AAAI,AAAA,AAACH,AAAE,AAAA,AAAIuC;AACTD;;AACA,AAAME,AAAK,AAACJ,AAAQ,AAAA,AAAIG,AAAM,AAAA,AAAIA,AAAM,AAAA,AAAIA;AAA5C,AACE,AAAO,AAACE,AAAKH,AAAME;AAAMA;;;;;;;;AAEnC;;;;AAAA,AAAOE,AAGJC;AAHH,AAIMA,AACA,AAAA,AAACjC,AAAY,AAAA,AAAA,AAAI,AAAA,AAACV,AAAU,AAAA,AAAO2C,AACnC,AAAA,AAACjC,AAAS,AAAG,AAAA,AAAIiC,AAAM,AAAA,AAAIA,AAC3B,AAAA,AAACjC,AAAS,AAAG,AAAA,AAAIiC;;AAEvB;;;AAAA,AAAOC,AAEJlD,AAAE4C,AAAMO;AAFX,AAGE,AAACrC,AAAO,AAAKsC,AAAOH;AAAZ,AACE,AAAAI,AAAyB,AAACF,AAAAA,AAAAA,AAAEF,AAAAA;AAA5BI,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAAC,AAAA,AAAAD,AAAA,AAAA,AAAA,AAAA,AAAAE,AAAAC,AAAAH,AAAAA;AAAA,AAAAzD,AAAAyD,AAAA,AAAcJ;AAAd,AAAArD,AAAAyD,AAAA,AAAmBjD;AAAnB,AAAAR,AAAAyD,AAAA,AAAqB7D;AACfa,AAAE,AAAA,AAAK,AAAGD,AAAEZ;AACZiE,AAAW,AAAA,AAAIL;AACfM,AAAY,AAACC,AAAKF;AAHxB,AAIE,AAAI,AAAA,AAACnD,AAAE2C;AACL,AAAA,AAACjC,AAAMoC,AAAU,AAACL,AAAK,AAAA,AAAIK,AAAQhD;;AACnC,AAAA,AAACY,AAAMoC,AAAU,AAAMQ,AAAM,AAAA,AAAKxD;AAAjB,AACE,AAAI,AAACE,AAAEsD,AAAM,AAACxB,AAAMsB;AAClB,AAACX,AAAK,AAACc,AAAI,AAACC,AAAQL,AACd,AAACV,AAAKW,AAAY,AAAC9D,AAAII,AAAEK;;AAC/B,AAAA,AAAC0C,AAAKU,AAAY,AAAA,AAAKrD,AAAG,AAACR,AAAII,AAAEK;;;;AAXpE,AAAA,AAAA,AAAA,AAAA,AAcQuC;;AAEV,AAAA,AAAA,AAAAmB,AAAMM;AAAN,AAAA,AAAAL,AAAA;AAAA,AAAA,AAAAC,AAAA,AAAA;AAAA,AAAA,AAAAC,AAAA;;AAAA,AAAA,AAAA,AAAAA,AAAAD;AAAA,AAAA,AAAAD,AAAA,AAAA,AAAAE;;AAAA,AAAA,AAAAA,AAAA;;;;AAAA;;;;AAAA,AAAAC,AAAA,AAAA,AAAA,AAAA,AAAAH,AAAA,AAAA,AAAAI,AAAA,AAAAJ,AAAA,AAAA,AAAA,AAAA;AAAA,AAAA,AAAAK,AAAAF;;;AAAA,AAAA,AAAA,AAAA,AAAME,AAAaI;AAAnB,AACE,AAAA,AAAAC,AAAClC;AAAD,AAAM,AAACqB,AAAI,AAAA,AAAAa,AAACC;AAAaF;;;AAD3B,AAAA,AAAA,AAAMJ;;AAAN;AAAA,AAAA,AAAA,AAAAC,AAAMD;AAAN,AAAA,AAAAE,AAAA;AAAA,AAAA,AAAAA,AAAA,AAAAC,AAAAF;;;AAAA,AAGA,AAAA,AAAMM,AACH7E,AAAEC;AADL,AAEE,AAAA6E,AAAc,AAAA,AAAA,AAAI,AAAG,AAAC3D,AAAMlB,AAAG,AAACkB,AAAMnB,AAAKC,AAAED,AAAIA,AAAEC;AAAnD,AAAA8E,AAAAD,AAAA,AAAA,AAAOE;AAAP,AAAAD,AAAAD,AAAA,AAAA,AAAUG;AAAV,AAAA,AACG,AAAC/D,AAAI8D,AAAGC,AAAID,AAAGC;;AAEpB,AAAA,AAAMC,AACHlF,AAAEC;AADL,AAEE,AAAAkF,AAAY,AAACE,AAAUrF,AAAEC;AAAzB,AAAA8E,AAAAI,AAAA,AAAA,AAAOnF;AAAP,AAAA+E,AAAAI,AAAA,AAAA,AAASlF;AAATmF,AACiB,AAACP,AAAW7E,AAAEC;AAD/B,AAAA8E,AAAAK,AAAA,AAAA,AACOE;AADP,AAAAP,AAAAK,AAAA,AAAA,AACUJ;AADV,AAAAD,AAAAK,AAAA,AAAA,AACaH;AACPpC,AAAM,AAACW,AAAMd,AAAMsC,AAAGC,AAAGK;AAF/B,AAGE,AAACnC,AAAclD,AAAE4C,AAAM,AAAI,AAACtC,AAAEyE,AAAGhF,AAAGuF,AAAStC;;AAEjD,AAAA,AAAMuC,AAAiBxF,AAAEC;AAAzB,AACE,AAAM,AAAK,AAASD,AAAG,AAASC;AAAhC,AAAA;;AAAA;;;AAEF,AAAA,AAAAwF,AAAAC,AAAAC;AAAA;AAAA,AAAA;;;;;;AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAgCQ;AAAhCP,AAAA,AAAAD,AAAA;AAAAE,AAAA,AAAAF,AAAA;AAAAG,AAAA,AAAAH,AAAA;AAAAI,AAAA,AAAApG,AAAA,AAAA,AAAA,AAAAqG,AAAA;AAAA,AAAA,AAAAA,AAAAA,AAAAA;;AAAA,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAAH,AAAAL,AAAAE,AAAAC,AAAAC,AAKER;;;AAEF,AAAAa,AAAA,AAAA,AACGrG,AAAEC;AADL,AAEE,AAACiF,AAASlF,AAAEC;;AAOd,AAAA,AAAMqG,AACHtG,AAAEC;AADL,AAEE,AAAAsG,AAAY,AAAClB,AAAUrF,AAAEC;AAAzB,AAAA8E,AAAAwB,AAAA,AAAA,AAAOvG;AAAP,AAAA+E,AAAAwB,AAAA,AAAA,AAAStG;AAATuG,AACyB,AAAC3B,AAAW7E,AAAEC;AADvCwG,AAAA,AAAA1B,AAAAyB,AAAA,AAAA;AAAAE,AAAA,AAAAjC,AAAAgC;AAAAE,AAAA,AAAAtE,AAAAqE;AAAAA,AAAA,AAAAE,AAAAF;AAAAC,AACQlG;AADRiG,AACYhC;AADZ,AAAAK,AAAAyB,AAAA,AAAA,AACkBxB;AADlB,AAAAD,AAAAyB,AAAA,AAAA,AACqBvB;AADrB,AAEE,AAAG,AAAA,AAAKxE,AAAG,AAAG,AAACU,AAAM6D,AAAI,AAAC7D,AAAM8D;;AAEpC,AAAA,AAAAQ,AAAAC,AAAAmB;AAAA;AAAA,AAAA,AAAA,AAAAjB,AAAA,AAAAC,AAAA,AAAUkB;AAAVjB,AAAA,AAAAD,AAAA;AAAAE,AAAA,AAAAF,AAAA;AAAAG,AAAA,AAAAH,AAAA;AAAAI,AAAA,AAAApG,AAAA,AAAA,AAAA,AAAAiH,AAAA;AAAA,AAAA,AAAAA,AAAAA,AAAAA;;AAAA,AAAA,AAAAX,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAAH,AAAAL,AAAAE,AAAAC,AAAAC,AAAwBR;;;AAExB,AAAAuB,AAAA,AAAA,AACG/G,AAAEC;AADL,AAEE,AAACqG,AAActG,AAAEC;;AAInB,AAAA8G,AAAA,AAAA,AACG/G,AAAEC;AADL,AAEE,AAACqG,AAActG,AAAEC;;AAEnB,AAAA,AAAM+G,AACHhH,AAAEC;AADL,AAEE,AAAMgH,AAAK,AAAC/B,AAASlF,AAAEC;AACjBiH,AAAU,AAAA,AAAID;AADpB,AAEE,AAAA,AAAAE,AAAC5E;AAAD,AAAS,AAAA4E,AAAA,AAACC;AACF,AAACrG,AAAO,AAAKsG,AAAKtE;AAAV,AACE,AAAA,AAAC9B,AAAMoG,AAAKtE;AACd,AAACe,AAAI,AAACW,AAAIzE,AACVkH;;AAEpB,AAAA,AAAAzB,AAAAC,AAAA4B;AAAA;AAAA,AAAA,AAAA,AAAA1B,AAAA,AAAAC,AAAA,AAAU2B;AAAV1B,AAAA,AAAAD,AAAA;AAAAE,AAAA,AAAAF,AAAA;AAAAG,AAAA,AAAAH,AAAA;AAAAI,AAAA,AAAApG,AAAA,AAAA,AAAA,AAAA0H,AAAA;AAAA,AAAA,AAAAA,AAAAA,AAAAA;;AAAA,AAAA,AAAApB,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAAH,AAAAL,AAAAE,AAAAC,AAAAC,AAAgCR;;;AAEhC,AAAAgC,AAAA,AAAA,AACGxH,AAAEC;AADL,AAEE,AAAC+G,AAAQhH,AAAEC;;AAEb,AAAAuH,AAAA,AAAA,AACGxH,AAAEC;AADL,AAEE,AAACuD,AAAMiE,AAAI,AAACT,AAAQhH,AAAEC","names":["clj-diff.miller/next-x","k","fp","x__4214__auto__","y__4215__auto__","cljs.core.get","js/Error","clj-diff.miller/snake","a","b","n","m","cljs.core/vector?","x","y","cljs.core._EQ_","clj-diff.miller/p-band-diagonals","p","delta","cljs.core.concat","cljs.core.range","cljs.core/reverse","clj-diff.miller/search-p-band","cljs.core.reduce","next-k","cljs.core.assoc","clj-diff.miller/ses","cljs.core/count","clj-diff.miller/edit-dist","clj-diff.miller/p-value-up","clj-diff.miller/p-value-left","clj-diff.miller/look-up","graph","up-k","up-p","x*","clj-diff.miller/look-left","left-k","left-p","clj-diff.miller/backtrack-snake","%","clj-diff.miller/next-edit","d","head-x","move","cljs.core/first","p1__49731#","cljs.core.filter","p1__49732#","cljs.core.map","clj-diff.miller/edits","next-fn","cljs.core.partial","edits","prev","next","cljs.core.conj","clj-diff.miller/transpose","edit","clj-diff.miller/edits->script","f","script","map__49785","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","insertions","last-insert","cljs.core/last","index","cljs.core/vec","cljs.core/butlast","var_args","args__4742__auto__","len__4736__auto__","i__4737__auto__","argseq__4743__auto__","cljs.core/IndexedSeq","clj-diff.miller/vectorize","seq49834","self__4724__auto__","cljs.core/seq","more","p1__49832#","cljs.core/cons","clj-diff.miller/order->ses","vec__49862","cljs.core.nth","a*","b*","clj-diff.miller/seq-diff","vec__49877","vec__49880","clj_diff.miller.vectorize","es","cljs.core/identity","clj-diff.miller/string-dispatch","js/clj-diff","js/clj-diff.miller","js/clj-diff.miller.diff","method-table__4619__auto__","cljs.core.atom","prefer-table__4620__auto__","method-cache__4621__auto__","cached-hierarchy__4622__auto__","hierarchy__4623__auto__","fexpr__49905","cljs.core/MultiFn","cljs.core.symbol","clj-diff.miller/diff","clj-diff.miller/seq-edit-dist","vec__49915","vec__49918","vec__49921","seq__49922","first__49923","cljs.core/next","js/clj-diff.miller.edit-distance","fexpr__49946","clj-diff.miller/edit-distance","clj-diff.miller/seq-lcs","diff","deletions","p1__49965#","cljs.core.not_EQ_","coll","js/clj-diff.miller.longest-common-subseq","fexpr__49990","clj-diff.miller/longest-common-subseq","cljs.core/str"],"sourcesContent":["(ns clj-diff.miller\n  \"Algorithm from 'An O(NP) Sequence Comparison Algorithm' by\n   Sun Wu, Udi Manber, Gene Myers and Web Miller.\n\n   Please refer to the above paper while reading this code.\"\n  #?(:clj (:require [clj-diff [optimizations :as opt]])))\n\n(defn- next-x\n  \"Get the next farthest x value by looking at previous farthest values on the\n  diagonal above and below diagonal k. Choose the greater of the farthest x on\n  the above diagonal and the farthest x on the diagonal below plus one. fp is\n  a map of diagonals => farthest points.\"\n  [k fp]\n  (max (inc (get fp (dec k) -1))\n       (get fp (inc k) -1)))\n\n(defn- snake\n  \"Starting at the farthest point on diagonal k, return the x value of the\n  point at the end of the longest snake on this diagonal. A snake is a\n  sequence of diagonal moves connecting match points on the edit graph.\"\n  [a b n m k fp]\n  {:pre [(and (vector? a) (vector? b))]}\n  (let [x (next-x k fp)\n        y (- x k)]\n    (loop [x x\n           y y]\n      (if (and (< x n) (< y m) (= (get a (inc x)) (get b (inc y))))\n        (recur (inc x) (inc y))\n        x))))\n\n(defn- p-band-diagonals\n  \"Given a p value and a delta, return all diagonals in this p-band.\"\n  [p delta]\n  (concat (range (* -1 p) delta)\n          (reverse (range (inc delta) (+ delta (inc p))))\n          [delta]))\n\n(defn- search-p-band\n  \"Given a p value, search all diagonals in the p-band for the furthest\n  reaching endpoints. Record the furthest reaching endpoint for each p value\n  in the map fp. Returns an updated fp map for p. a and b are the two\n  sequences and n and m are their lengths respectively. delta is the\n  diagonal of the sink and is equal to n - m.\"\n  [a b n m delta p fp]\n  (reduce (fn [fp next-k]\n            (assoc fp next-k (snake a b n m next-k fp)))\n          fp\n          (p-band-diagonals p delta)))\n\n(defn ses\n  \"Find the size of the shortest edit script (ses). Returns a 3-tuple of the\n  size of the ses, the delta value (which is the diagonal of the sink)\n  and the fp map. The optimal path from source to sink can be constructed from\n  this information.\"\n  [a b]\n  {:pre [(>= (count a) (count b))]}\n  (let [n (dec (count a))\n        m (dec (count b))\n        delta (- n m)]\n    (loop [p 0\n           fp {}]\n      (if (= (-> (get fp (dec p) {})\n                 (get delta))\n             n)\n        [(dec p) delta fp]\n        (recur (inc p)\n               (assoc fp p\n                      (search-p-band a b n m delta p (get fp (dec p) {}))))))))\n\n;;\n;; Build the edit script from the map of farthest endpoints.\n;;\n\n(defn edit-dist\n  \"Given a delta, p and k value, calculate the edit distance.\"\n  [delta p k]\n  (if (> k delta)\n    (+ (* 2 (- p (- k delta))) k)\n    (+ (* 2 p) k)))\n\n(defn- p-value-up\n  \"Calculate the p value that will be used to look up the farthest reaching\n  end point for the diagonal above k.\"\n  [delta p k]\n  (if (> (inc k) delta) p (dec p)))\n\n(defn- p-value-left\n  \"Calculate the p value that will be used to look up the farthest reaching\n  end point for the diagonal below k.\"\n  [delta p k]\n  (if (< (dec k) delta) p (dec p)))\n\n(defn- look-up\n  \"Get information about the vertex above the one at x on k. If this vertex\n  is chosen, it will represent an insertion.\"\n  [graph delta p x k]\n  (when (> (- x k) 0)\n    (let [up-k (inc k)\n          up-p (p-value-up delta p k)\n          x* (-> graph\n                 (get up-p {})\n                 (get up-k -1))]\n      (when (and (>= x* 0) (= x x*))\n        {:edit :insert\n         :x x*\n         :p up-p\n         :k up-k\n         :d (edit-dist delta up-p up-k)}))))\n\n(defn- look-left\n  \"Get information about the vertex to the left of the one at x on k. If this\n  vertex is chosen, it will represent an deletion.\"\n  [graph delta p x k]\n  (when (> x 0)\n    (let [left-k (dec k)\n          left-p (p-value-left delta p k)\n          x* (-> graph\n                 (get left-p {})\n                 (get left-k -1))]\n      (when (and (>= x* 0) (= (dec x) x*))\n        {:edit :delete\n         :x x*\n         :p left-p\n         :k left-k\n         :d (edit-dist delta left-p left-k)}))))\n\n(defn- backtrack-snake\n  \"Find the x value at the head of the longest snake ending at (x, y).\"\n  [a b x y]\n  {:pre [(and (>= x 0) (>= y 0))]}\n  (loop [x x\n         y y]\n    (if (or (= x y 0) (not (= (get a x) (get b y))))\n      x\n      (recur (dec x) (dec y)))))\n\n;; See the paper for an example of how there are multiple shortest\n;; paths through an edit graph.\n\n(defn- next-edit\n  \"Find the next move through the edit graph which will decrease the\n  edit distance by 1.\"\n  [a b graph delta p x k]\n  {:post [(= (dec (edit-dist delta p k)) (:d %))]}\n  (let [d (edit-dist delta p k)\n        head-x (backtrack-snake a b x (- x k))]\n    (loop [head-x head-x]\n      (let [move (first (filter #(and (not (nil? %)) ;; <<<===\n                                      (= (:d %) (dec d)))\n                                (map #(% graph delta p head-x k)\n                                     [look-left look-up])))]\n        (if (and (< head-x x) (nil? move))\n          (recur (inc head-x))\n          move)))))\n\n(defn- edits\n  \"Calculate the sequence of edits from the map of farthest reaching end\n  points.\"\n  [a b p delta graph]\n  (let [next-fn (partial next-edit a b graph delta)]\n    (loop [edits '()\n           prev {:x (count a) :p p :k delta\n                 :d (edit-dist delta p delta)}]\n      (if (= (:d prev) 0)\n        edits\n        (let [next (next-fn (:p prev) (:x prev) (:k prev))]\n          (recur (conj edits next) next))))))\n\n(defn- transpose\n  \"If a is shorter than b, then the diff is calculated from b to a and this\n  function is used to transpose the results into a diff from a to b.\"\n  [edit]\n  (-> edit\n      (assoc :edit (if (= :insert (:edit edit)) :delete :insert))\n      (assoc :x (- (:x edit) (:k edit)))\n      (assoc :k (- (:k edit)))))\n\n(defn- edits->script\n  \"Convert a sequence of edits into an edit script.\"\n  [b edits f]\n  (reduce (fn [script edit]\n            (let [{:keys [edit x k]} (f edit)\n                  y (inc (- x k))\n                  insertions (:+ script)\n                  last-insert (last insertions)]\n              (if (= edit :delete)\n                (assoc script :- (conj (:- script) x))\n                (assoc script :+ (let [index (dec x)]\n                                   (if (= index (first last-insert))\n                                     (conj (vec (butlast insertions))\n                                           (conj last-insert (get b y)))\n                                     (conj insertions [(dec x) (get b y)])))))))\n          {:+ []\n           :- []}\n          edits))\n\n(defn vectorize [& more]\n  (map #(vec (cons nil %)) more))\n\n(defn order->ses\n  [a b]\n  (let [[a* b*] (if (> (count b) (count a)) [b a] [a b])]\n    [(ses a* b*) a* b*]))\n\n(defn seq-diff\n  [a b]\n  (let [[a b] (vectorize a b)\n        [es a* b*] (order->ses a b)\n        edits (apply edits a* b* es)]\n    (edits->script b edits (if (= a* a) identity transpose))))\n\n(defn string-dispatch [a b]\n  (when (and (string? a) (string? b)) :string))\n\n(defmulti ^{:arglists '([a b])} diff\n  \"Create an edit script that may be used to transform a into b. See doc string\n  for clj-diff.core/diff. This function will ensure that diff* is called with\n  arguments a and b where a >= b. If the passed values of a and b need to be\n  swapped then the resulting path with will transposed.\"\n  string-dispatch)\n\n(defmethod diff :default\n  [a b]\n  (seq-diff a b))\n\n#?(:clj\n(defmethod diff :string\n  [a b]\n  (opt/diff a b seq-diff)))\n\n(defn seq-edit-dist\n  [a b]\n  (let [[a b] (vectorize a b)\n        [[p & more] a* b*] (order->ses a b)]\n    (+ (* 2 p) (- (count a*) (count b*)))))\n\n(defmulti edit-distance string-dispatch)\n\n(defmethod edit-distance :default\n  [a b]\n  (seq-edit-dist a b))\n\n;; TODO - Modify optimizations so that it can be used here and with\n;; longest-common-subseq\n(defmethod edit-distance :string\n  [a b]\n  (seq-edit-dist a b))\n\n(defn seq-lcs\n  [a b]\n  (let [diff (seq-diff a b)\n        deletions (:- diff)]\n    (filter #(not= % ::d)\n            (reduce (fn [coll next]\n                      (assoc coll next ::d))\n                    (vec (seq a))\n                    deletions))))\n\n(defmulti longest-common-subseq string-dispatch)\n\n(defmethod longest-common-subseq :default\n  [a b]\n  (seq-lcs a b))\n\n(defmethod longest-common-subseq :string\n  [a b]\n  (apply str (seq-lcs a b)))\n"]}